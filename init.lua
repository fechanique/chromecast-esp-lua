chromecastIp = "192.168.1.139"
port = 8009
appId = "AF34CB76"

function bytesToString(t)
  local chars = {}
  for i,v in ipairs(t) do
    chars[i] = string.char(v)
  end
  return table.concat(chars)
end

connectMessageBody = {
    0x08,0x00,
    0x12,0x08,0x73,0x65,0x6e,0x64,0x65,0x72,0x2d,0x30,
    0x1a,0x0a,0x72,0x65,0x63,0x65,0x69,0x76,0x65,0x72,0x2d,0x30,
    0x22,0x28,
    0x75,0x72,0x6e,0x3a,0x78,0x2d,0x63,0x61,0x73,0x74,0x3a,
    0x63,0x6f,0x6d,0x2e,0x67,0x6f,0x6f,0x67,0x6c,0x65,0x2e,
    0x63,0x61,0x73,0x74,0x2e,0x74,0x70,0x2e,0x63,0x6f,
    0x6e,0x6e,0x65,0x63,0x74,0x69,0x6f,0x6e,
    0x28,0x00,
    0x32,0x12,
    0x7b,0x22,0x74,0x79,0x70,0x65,0x22,0x3a,0x22,
    0x43,0x4f,0x4e,0x4e,0x45,0x43,0x54,0x22,0x7d
}

getStatusMessage = {
    0x08,0x00,
    0x12,0x08,0x73,0x65,0x6e,0x64,0x65,0x72,0x2d,0x30,
    0x1a,0x0a,0x72,0x65,0x63,0x65,0x69,0x76,0x65,0x72,0x2d,0x30,
    0x22,0x23,
    0x75,0x72,0x6e,0x3a,0x78,0x2d,0x63,0x61,0x73,0x74,0x3a,
    0x63,0x6f,0x6d,0x2e,0x67,0x6f,0x6f,0x67,0x6c,0x65,0x2e,
    0x63,0x61,0x73,0x74,0x2e,0x72,0x65,0x63,0x65,0x69,0x76,
    0x65,0x72,
    0x28,0x00,
    0x32,0x23,
    0x7b,0x22,0x74,0x79,0x70,0x65,0x22,0x3a,0x22,0x47,0x45,
    0x54,0x5f,0x53,0x54,0x41,0x54,0x55,0x53,0x22,0x2c,0x22,
    0x72,0x65,0x71,0x75,0x65,0x73,0x74,0x49,0x64,0x22,0x3a,
    0x31,0x7d
}

heartbeatMessageBody = {
  0x08,0x00,                                      
  0x12,0x08,0x73,0x65,0x6e,0x64,0x65,0x72,0x2d,0x30,
  0x1a,0x0a,0x72,0x65,0x63,0x65,0x69,0x76,0x65,0x72,0x2d,0x30,
  0x22,0x27,
  0x75,0x72,0x6e,0x3a,0x78,0x2d,0x63,0x61,0x73,0x74,0x3a,
  0x63,0x6f,0x6d,0x2e,0x67,0x6f,0x6f,0x67,0x6c,0x65,0x2e,
  0x63,0x61,0x73,0x74,0x2e,0x74,0x70,0x2e,
  0x68,0x65,0x61,0x72,0x74,0x62,0x65,0x61,0x74,
  0x28,0x00,
  0x32,0x0f,
  0x7b,0x22,0x74,0x79,0x70,0x65,0x22,0x3a,0x22,0x50,0x49,0x4e,0x47,0x22,0x7d
}

launchMessageBody = {
    0x08,0x00,                                  
    0x12,0x08,0x73,0x65,0x6e,0x64,0x65,0x72,0x2d,0x30,
    0x1a,0x0a,0x72,0x65,0x63,0x65,0x69,0x76,0x65,0x72,0x2d,0x30,
    0x22,0x23,                                 
    0x75,0x72,0x6e,0x3a,0x78,0x2d,0x63,0x61,0x73,0x74,0x3a,
    0x63,0x6f,0x6d,0x2e,0x67,0x6f,0x6f,0x67,0x6c,0x65,0x2e,
    0x63,0x61,0x73,0x74,0x2e,0x72,0x65,0x63,0x65,0x69,
    0x76,0x65,0x72,                           
    0x28,0x00,                                 
    0x32,0x32,                                 
    0x7b,0x22,0x74,0x79,0x70,0x65,0x22,0x3a,0x22,0x4c,0x41,0x55,
    0x4e,0x43,0x48,0x22,0x2c,0x22,0x61,0x70,0x70,0x49,0x64,0x22,
    0x3a,0x22,0x41,0x46,0x33,0x34,0x43,0x42,0x37,0x36,0x22,0x2c,
    0x22,0x72,0x65,0x71,0x75,0x65,0x73,0x74,0x49,0x64,0x22,0x3a,
    0x31,0x7d
}

function sendProtobufMessage(conn, bodyTable)
    local body = bytesToString(bodyTable)
    local length = #body
    -- Convertimos length a 4 bytes big-endian
    local b1 = bit.rshift(bit.band(length,0xFF000000),24)
    local b2 = bit.rshift(bit.band(length,0x00FF0000),16)
    local b3 = bit.rshift(bit.band(length,0x0000FF00),8)
    local b4 = bit.band(length,0x000000FF)
    local header = string.char(b1, b2, b3, b4)
    conn:send(header .. body)
end

conn = tls.createConnection()
conn:on("connection", function(sck)
    print("Conectado al Chromecast")
    sendProtobufMessage(sck, connectMessageBody)
    tmr.create():alarm(5000, tmr.ALARM_AUTO, function()
        sendProtobufMessage(sck, heartbeatMessageBody)
    end)
end)

conn:on("receive", function(sck, data)
    print("Recibido:", data)
end)

conn:on("disconnection", function(sck)
    print("Conexi√≥n cerrada")
end)

gpio.mode(3, gpio.INPUT)
gpio.trig(3, 'up', function(l) 
    sendProtobufMessage(conn, launchMessageBody)
end)

conn:connect(port, chromecastIp)
